#include <Wire.h>
#include "veml6040.h"
#include <BME280I2C.h>
#include <Ethernet.h>
#include "ThingSpeak.h"

#define SECRET_MAC {0x90, 0xA2, 0xDA, 0x10, 0x40, 0x69}

// ---------- Ethernet / ThingSpeak ----------
byte mac[] = SECRET_MAC;

IPAddress ip(192, 168, 0, 177);
IPAddress myDns(192, 168, 0, 1);

EthernetClient client;

unsigned long myChannelNumber = 3219366;
const char * myWriteAPIKey = "GDPJAIAU6S696IDP";

// ---------- Sensors ----------
VEML6040 RGBWSensor;
BME280I2C bme;

// ---------- Globals ----------
float temperature = NAN;
float humidity    = NAN;
float ambientLux  = NAN;

//////////////////////////////////////////////////////////////////
void setup() {
  Serial.begin(115200);
  while (!Serial) {}

  Wire.begin();

  // ---------- VEML6040 ----------
  if (!RGBWSensor.begin()) {
    Serial.println("ERROR: couldn't detect VEML6040");
    while (1) {}
  }

  RGBWSensor.setConfiguration(
    VEML6040_IT_320MS +
    VEML6040_AF_AUTO +
    VEML6040_SD_ENABLE
  );

  Serial.println("VEML6040 initialized");

  // ---------- BME280 ----------
  while (!bme.begin()) {
    Serial.println("Could not find BME280 sensor!");
    delay(1000);
  }

  Serial.println("BME280 initialized");

  // ---------- Ethernet ----------
  Ethernet.init(10);
  Serial.println("Initialize Ethernet with DHCP:");

  if (Ethernet.begin(mac) == 0) {
    Serial.println("DHCP failed, using static IP");
    Ethernet.begin(mac, ip, myDns);
  } else {
    Serial.print("DHCP IP: ");
    Serial.println(Ethernet.localIP());
  }

  delay(1000);

  ThingSpeak.begin(client);

  Serial.println("ThingSpeak initialized");
  Serial.println();
}

//////////////////////////////////////////////////////////////////
void loop() {
  // ---------- READ VEML6040 ----------
  ambientLux = RGBWSensor.getAmbientLight();

  // ---------- READ BME280 ----------
  float pres;
  BME280::TempUnit tempUnit(BME280::TempUnit_Celsius);
  BME280::PresUnit presUnit(BME280::PresUnit_Pa);

  bme.read(pres, temperature, humidity, tempUnit, presUnit);

  // ---------- SERIAL OUTPUT ----------
  Serial.println("===== SENSOR DATA =====");

  Serial.print("Temp: ");
  Serial.print(temperature);
  Serial.println(" Â°C");

  Serial.print("Humidity: ");
  Serial.print(humidity);
  Serial.println(" %");

  Serial.print("Ambient Light (AL): ");
  Serial.print(ambientLux);
  Serial.println(" lux");

  // ---------- THINGSPEAK ----------
  ThingSpeak.setField(1, temperature);
  ThingSpeak.setField(2, humidity);
  ThingSpeak.setField(3, ambientLux);

  int x = ThingSpeak.writeFields(myChannelNumber, myWriteAPIKey);

  if (x == 200) {
    Serial.println("ThingSpeak update successful.");
  } else {
    Serial.println("ThingSpeak error: HTTP " + String(x));
  }

  Serial.println();
  delay(20000);   // ThingSpeak minimum update interval
}
